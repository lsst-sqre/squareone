version: 2

updates:
  # npm/pnpm package ecosystem
  - package-ecosystem: 'npm'
    directory: '/'
    schedule:
      interval: 'monthly'
      day: 'monday'
      time: '03:00'
    open-pull-requests-limit: 15
    rebase-strategy: 'auto'
    commit-message:
      prefix: 'chore'
      include: 'scope'

    # Block major version updates globally (manual review required)
    ignore:
      - dependency-name: '*'
        update-types: ['version-update:semver-major']

    registries:
      - npm-github

    # Cooldown to mitigate supply chain attacks
    # Security updates bypass cooldown automatically
    cooldown:
      default-days: 5
      semver-patch-days: 3
      semver-minor-days: 5
      exclude:
        # Core framework packages from trusted publishers
        - 'react'
        - 'react-dom'
        - 'next'
        - '@next/*'
        - 'typescript'
        # Type definitions (low risk, from DefinitelyTyped)
        - '@types/*'

    groups:
      # Security updates - patch and minor versions (FIRST - highest priority)
      security-patch:
        applies-to: security-updates
        update-types:
          - 'patch'
          - 'minor'
        patterns:
          - '*'

      # React ecosystem
      react:
        patterns:
          - 'react'
          - 'react-dom'
          - '@types/react'
          - '@types/react-dom'

      # Next.js framework and plugins
      nextjs:
        patterns:
          - 'next'
          - '@next/*'
          - 'next-*'
          - 'eslint-config-next'

      # Storybook ecosystem
      storybook:
        patterns:
          - 'storybook'
          - '@storybook/*'
          - 'eslint-plugin-storybook'
          - 'msw'
          - 'msw-storybook-addon'

      # Playwright browser testing
      # (grouped to ensure GitHub Actions is also updated)
      playwright:
        patterns:
          - 'playwright'
          - '@playwright/*'

      # Monorepo infrastructure (Turborepo + Changesets)
      monorepo-infra:
        patterns:
          - 'turbo'
          - '@turbo/*'
          - 'eslint-config-turbo'
          - '@changesets/*'

      # Catchall for development dependencies
      development:
        dependency-type: 'development'
        patterns:
          - '*'

      # Catchall for runtime dependencies
      runtime:
        dependency-type: 'production'
        patterns:
          - '*'

  # GitHub Actions updates
  - package-ecosystem: 'github-actions'
    directory: '/'
    schedule:
      interval: 'monthly'
      day: 'tuesday'
    rebase-strategy: 'auto'
    groups:
      actions:
        patterns:
          - '*'

  # Python dependencies (pip)
  - package-ecosystem: 'pip'
    directory: '/'
    schedule:
      interval: 'monthly'
      day: 'wednesday'
    rebase-strategy: 'auto'

  # Docker base images
  - package-ecosystem: 'docker'
    directory: '/'
    schedule:
      interval: 'monthly'
      day: 'wednesday'
    rebase-strategy: 'auto'

registries:
  npm-github:
    type: npm-registry
    url: https://npm.pkg.github.com
    # lsst-sqre org secret (for Dependabot)
    token: ${{ secrets.READONLY_PACKAGES_GITHUB_TOKEN }}
